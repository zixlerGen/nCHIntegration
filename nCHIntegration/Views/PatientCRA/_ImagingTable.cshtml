@model nCHIntegration.ViewModels.PatientImagingViewModel
@{
    var xrayList = Model.XrayList;
    var hn = Model.HN;
    ViewData["Title"] = $"Imaging Result - {hn}";
}

<style>
    /* ปรับแต่งเพื่อให้ Card มีความสูงเท่ากันในแถวเดียวกัน */
    .imaging-card {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .card-body-scroll {
        /* ให้เนื้อหา Findings สามารถ Scroll ได้หากยาวเกินไป */
        max-height: 250px;
        overflow-y: auto;
        white-space: pre-wrap; /* รักษาการจัดรูปแบบ Rich_Text_Memo */
        font-size: 0.9rem;
    }

    .card-footer-fixed {
        margin-top: auto; /* ตรึงปุ่มไว้ด้านล่าง */
        padding-top: 0.75rem;
    }
</style>

@if (xrayList == null || !xrayList.Any())
{
    <div class="alert alert-warning border-0 shadow-sm" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> No X-Ray/Imaging results found for this patient.
    </div>
}
else
{
    @* ส่วน Filter ยังคงเดิม *@
    <div class="mb-4 p-3 bg-light border rounded">
        <form method="get" asp-controller="PatientCRA" asp-action="GetTbPatientImagingDataView">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label for="filterDate" class="form-label">Filter by Xray Date:</label>
                    <input type="date" id="filterDate" name="filterDate" class="form-control" />
                </div>
                <div class="col-md-auto mt-3 mt-md-0">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> ค้นหา
                    </button>
                </div>
                <input type="hidden" name="hn" value="@hn" />
            </div>
        </form>
    </div>
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-x-ray me-2"></i> Imaging Results (HN: <span class="fw-bold">@hn</span>)
            </h5>
        </div>
    </div>
    @* ส่วนแสดงผล X-Ray แบบ Card *@
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var xray in xrayList)
        {
            <div class="col">
                <div class="card shadow-sm imaging-card border-left-primary">

                    @* Card Header: แสดงชื่อ Xray และ Request No *@
                    <div class="card-header bg-primary text-white py-2">
                        <div class="fw-bold fs-6">@xray.xray_name_english</div>
                        <small class="text-white-50">Request No: **@xray.Request_No**</small>
                    </div>

                    @* Card Body: แสดง Findings/Memo *@
                    <div class="card-body p-3">
                        <div class="text-muted mb-2">
                            <i class="bi bi-calendar-check me-1"></i> Xray Date: @(xray.Date_Of_Xray?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")
                        </div>
                        <h6 class="card-subtitle mb-2 text-dark fw-semibold">Memo / Findings:</h6>

                        @* ใช้ Div สำหรับ Memo เพื่อให้ Scroll ได้ *@
                        <div class="bg-light p-2 border rounded card-body-scroll">
                            @xray.Rich_Text_Memo
                        </div>
                    </div>

                    @* Card Footer: แสดงปุ่ม Save *@
                    <div class="card-footer card-footer-fixed text-end bg-white border-top-0">
                        <button type="button"
                                class="btn btn-success save-single-xray-btn"
                                data-requestno="@xray.Request_No"
                                data-hn="@hn">
                            <i class="bi bi-check-circle-fill me-1"></i> Selected X-rays
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
}